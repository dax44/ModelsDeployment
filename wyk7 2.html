<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pl" xml:lang="pl"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Wdrażanie modeli uczenia maszynowego - Wykład 7</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Brak wyników",
    "search-matching-documents-text": "dopasowane dokumenty",
    "search-copy-link-title": "Kopiuj link do wyszukiwania",
    "search-hide-matches-text": "Ukryj dodatkowe dopasowania",
    "search-more-match-text": "więcej dopasowań w tym dokumencie",
    "search-more-matches-text": "więcej dopasowań w tym dokumencie",
    "search-clear-button-title": "Wyczyść",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Anuluj",
    "search-submit-button-title": "Zatwierdź",
    "search-label": "Szukaj"
  }
}</script>
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Wdrażanie modeli uczenia maszynowego</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Szukaj"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Przełącz nawigację" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="./Wdrażanie modeli uczenia maszynowego.html"> 
<span class="menu-text">Wstęp</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./wyk1.html"> 
<span class="menu-text">Wykład 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./wyk2.html"> 
<span class="menu-text">Wykład 2</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./wyk3.html"> 
<span class="menu-text">Wykład 3</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./wyk4.html"> 
<span class="menu-text">Wykład 4</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./wyk5.html"> 
<span class="menu-text">Wykład 5</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./wyk6.html"> 
<span class="menu-text">Wykład 6</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./wyk7.html" aria-current="page"> 
<span class="menu-text">Wykład 7</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Przełącz tryb ciemny"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Wykład 7</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="tips-tricks" class="level1 page-columns page-full"><h1>Tips &amp; tricks</h1>
<section id="bookmarking" class="level2"><h2 class="anchored" data-anchor-id="bookmarking">Bookmarking</h2>
<p>Możliwość zapisywania i udostępniania stanu aplikacji Shiny poprzez zakładki (ang. <em>bookmarking</em>) znacząco rozszerza funkcjonalność tych aplikacji, czyniąc je bardziej interaktywnymi i przyjaznymi dla użytkownika. Poniżej znajduje się opis sposobów realizacji tej funkcjonalności, wraz z przykładami użycia.</p>
<section id="podstawowa-idea" class="level3"><h3 class="anchored" data-anchor-id="podstawowa-idea">Podstawowa idea</h3>
<p>Domyślnie aplikacje Shiny nie umożliwiają łatwego powrotu do wcześniej uzyskanego stanu ani udostępniania go innym. Aby to zmienić i umożliwić zapisywanie stanu aplikacji w URL, można wykorzystać funkcjonalność zakładek. Poniżej przedstawiono kroki niezbędne do osiągnięcia tego celu na przykładzie aplikacji generującej figury Lissajous:</p>
<ol type="1">
<li>
<p>Dodanie przycisku zakładki - w interfejsie użytkownika dodajemy <code><a href="https://rdrr.io/pkg/shiny/man/bookmarkButton.html">bookmarkButton()</a></code>, który umożliwia generowanie URL z zapisanym stanem aplikacji.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Kod</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">request</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">fluidPage</span><span class="op">(</span></span>
<span>    <span class="fu">sidebarLayout</span><span class="op">(</span></span>
<span>      <span class="fu">sidebarPanel</span><span class="op">(</span></span>
<span>        <span class="fu">sliderInput</span><span class="op">(</span><span class="st">"omega"</span>, <span class="st">"omega"</span>, value <span class="op">=</span> <span class="fl">1</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, max <span class="op">=</span> <span class="fl">2</span>, step <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>,</span>
<span>        <span class="fu">sliderInput</span><span class="op">(</span><span class="st">"delta"</span>, <span class="st">"delta"</span>, value <span class="op">=</span> <span class="fl">1</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">2</span>, step <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>,</span>
<span>        <span class="fu">sliderInput</span><span class="op">(</span><span class="st">"damping"</span>, <span class="st">"damping"</span>, value <span class="op">=</span> <span class="fl">1</span>, min <span class="op">=</span> <span class="fl">0.9</span>, max <span class="op">=</span> <span class="fl">1</span>, step <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span>,</span>
<span>        <span class="fu">numericInput</span><span class="op">(</span><span class="st">"length"</span>, <span class="st">"length"</span>, value <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>        <span class="fu">bookmarkButton</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu">mainPanel</span><span class="op">(</span><span class="fu">plotOutput</span><span class="op">(</span><span class="st">"fig"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</li>
<li><p>Transformacja UI w funkcję - aby umożliwić dynamiczne dostosowywanie interfejsu w zależności od zapisanych wartości, UI aplikacji musi być zdefiniowane jako funkcja.</p></li>
<li>
<p>Włączenie zakładek - w wywołaniu <code><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp()</a></code> dodajemy <code>enableBookmarking = "url"</code>, aby umożliwić zapisywanie stanu aplikacji w URL.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Kod</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">shinyApp</span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span>, enableBookmarking <span class="op">=</span> <span class="st">"url"</span><span class="op">)</span></span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Adnotacja
</div>
</div>
<div class="callout-body-container callout-body">
<p>Można ją wypróbować na stronie <a href="https://hadley.shinyapps.io/ms-bookmark-url" class="uri">https://hadley.shinyapps.io/ms-bookmark-url</a>. Jeśli pobawisz się aplikacją i dodasz do zakładek kilka interesujących stanów, zobaczysz, że wygenerowane adresy URL wyglądają mniej więcej tak:</p>
<ul>
<li><p><a href="https://hadley.shinyapps.io/ms-bookmark-url/?inputs&amp;damping=1&amp;delta=1&amp;length=100&amp;omega=1" class="uri">https://hadley.shinyapps.io/ms-bookmark-url/?inputs&amp;damping=1&amp;delta=1&amp;length=100&amp;omega=1</a></p></li>
<li><p><a href="https://hadley.shinyapps.io/ms-bookmark-url/?inputs&amp;damping=0.966&amp;delta=1.25&amp;length=100&amp;omega=-0.54" class="uri">https://hadley.shinyapps.io/ms-bookmark-url/?inputs&amp;damping=0.966&amp;delta=1.25&amp;length=100&amp;omega=-0.54</a></p></li>
<li><p><a href="https://hadley.shinyapps.io/ms-bookmark-url/?inputs&amp;damping=0.997&amp;delta=1.37&amp;length=500&amp;omega=-0.9" class="uri">https://hadley.shinyapps.io/ms-bookmark-url/?inputs&amp;damping=0.997&amp;delta=1.37&amp;length=500&amp;omega=-0.9</a></p></li>
</ul>
<p>Aby zrozumieć, co się dzieje, weźmy pierwszy adres URL i podzielmy go na części:</p>
<ul>
<li><p><code>http://</code> to “protokół” używany do komunikacji z aplikacją. Zawsze będzie to <code>http</code> lub <code>https</code>.</p></li>
<li><p><code>hadley.shinyapps.io/ms-bookmark-url</code> to lokalizacja aplikacji.</p></li>
</ul>
<p>Wszystko po <code>?</code> jest “parametrem”. Każdy parametr jest oddzielony znakiem <code>&amp;</code>, a jeśli go rozdzielisz, możesz zobaczyć wartości każdego wejścia w aplikacji:</p>
<ul>
<li><code>damping=1</code></li>
<li><code>delta=1</code></li>
<li><code>length=100</code></li>
<li><code>omega=1</code></li>
</ul>
<p>Tak więc “wygenerowanie zakładki” oznacza zapisanie aktualnych wartości danych wejściowych w parametrach adresu URL. Jeśli zrobisz to lokalnie, adresy URL będą wyglądać nieco inaczej:</p>
<ul>
<li><a href="http://127.0.0.1:4087/?inputs&amp;damping=1&amp;delta=1&amp;length=100&amp;omega=1" class="uri">http://127.0.0.1:4087/?inputs&amp;damping=1&amp;delta=1&amp;length=100&amp;omega=1</a></li>
<li><a href="http://127.0.0.1:4087/?inputs&amp;damping=0.966&amp;delta=1.25&amp;length=100&amp;omega=-0.54" class="uri">http://127.0.0.1:4087/?inputs&amp;damping=0.966&amp;delta=1.25&amp;length=100&amp;omega=-0.54</a></li>
<li><a href="http://127.0.0.1:4087/?inputs&amp;damping=0.997&amp;delta=1.37&amp;length=500&amp;omega=-0.9" class="uri">http://127.0.0.1:4087/?inputs&amp;damping=0.997&amp;delta=1.37&amp;length=500&amp;omega=-0.9</a></li>
</ul>
<p>Większość elementów jest taka sama, z wyjątkiem tego, że zamiast <code>hadley.shinyapps.io/ms-bookmark-url</code> jest coś w rodzaju <code>127.0.0.1:4087</code>. <code>127.0.0.1</code> to specjalny adres, który zawsze wskazuje na twój własny komputer, a <code>4087</code> to losowo przypisany port. Zwykle różne aplikacje otrzymują różne ścieżki lub adresy IP, ale nie jest to możliwe, gdy hostujesz wiele aplikacji na własnym komputerze.</p>
</div>
</div>
</section><section id="automatyczna-aktualizacja-url" class="level3"><h3 class="anchored" data-anchor-id="automatyczna-aktualizacja-url">Automatyczna aktualizacja URL</h3>
<p>Można także zautomatyzować proces aktualizacji URL bez konieczności klikania przycisku, używając odpowiednich funkcji w <code>server</code>. Poniżej znajduje się przykład, jak to zrealizować:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Kod</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Kod generujący treść aplikacji...</span></span>
<span>  </span>
<span>  <span class="fu">observe</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">reactiveValuesToList</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span>    <span class="va">session</span><span class="op">$</span><span class="fu">doBookmark</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu">onBookmarked</span><span class="op">(</span><span class="va">updateQueryString</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A to daje <a href="https://hadley.shinyapps.io/ms-bookmark-auto" class="uri">https://hadley.shinyapps.io/ms-bookmark-auto</a> - ponieważ adres URL jest teraz automatycznie aktualizowany, można wówczas usunąć przycisk zakładki z interfejsu użytkownika.</p>
</section><section id="zapisywanie-bogatszego-stanu-aplikacji" class="level3"><h3 class="anchored" data-anchor-id="zapisywanie-bogatszego-stanu-aplikacji">Zapisywanie bogatszego stanu aplikacji</h3>
<p>Dla bardziej złożonych aplikacji, gdzie URL może stać się zbyt długi lub konieczne jest zapisanie stanu plików, można użyć <code>enableBookmarking = "server"</code>. Ta opcja zapisuje stan aplikacji w pliku <code>.rds</code> na serwerze, generując krótki i jednoznaczny URL.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Kod</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">shinyApp</span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span>, enableBookmarking <span class="op">=</span> <span class="st">"server"</span><span class="op">)</span></span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Jeśli to zrobisz, zobaczysz, że przycisk zakładki generuje adresy URL takie jak:</p>
<ul>
<li><a href="http://127.0.0.1:4087/?_state_id_=0d645f1b28f05c97" class="uri">http://127.0.0.1:4087/?_state_id_=0d645f1b28f05c97</a></li>
<li><a href="http://127.0.0.1:4087/?_state_id_=87b56383d8a1062c" class="uri">http://127.0.0.1:4087/?_state_id_=87b56383d8a1062c</a></li>
<li><a href="http://127.0.0.1:4087/?_state_id_=c8b0291ba622b69c" class="uri">http://127.0.0.1:4087/?_state_id_=c8b0291ba622b69c</a></li>
</ul>
<p>Które są sparowane z pasującymi katalogami w katalogu roboczym:</p>
<ul>
<li><code>shiny_bookmarks/0d645f1b28f05c97</code></li>
<li><code>shiny_bookmarks/87b56383d8a1062c</code></li>
<li><code>shiny_bookmarks/c8b0291ba622b69c</code></li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ostrzeżenie
</div>
</div>
<div class="callout-body-container callout-body">
<p>Główną wadą zakładek serwerowych jest to, że wymagają one zapisywania plików na serwerze i nie jest oczywiste, jak długo muszą one być przechowywane. Jeśli dodajesz do zakładek złożone stany i nigdy nie usuwasz tych plików, twoja aplikacja będzie z czasem zajmować coraz więcej miejsca na dysku. Jeśli usuniesz pliki, niektóre stare zakładki przestaną działać.</p>
</div>
</div>
</section><section id="wyzwania-z-zakładkami" class="level3"><h3 class="anchored" data-anchor-id="wyzwania-z-zakładkami">Wyzwania z zakładkami</h3>
<p>Automatyczne zakładkowanie opiera się na grafie reaktywnym. Inicjuje ono wejścia zapisanymi wartościami, a następnie odtwarza wszystkie wyrażenia i wyjścia reaktywne, co skutkuje wygenerowaniem tej samej aplikacji, którą widzisz, o ile graf reaktywny twojej aplikacji jest prosty. Poniżej pokrótce omawiam niektóre przypadki, które wymagają dodatkowej uwagi:</p>
<ul>
<li>Jeśli twoja aplikacja używa liczb losowych, wyniki mogą być różne, nawet jeśli wszystkie wejścia są takie same. Jeśli naprawdę ważne jest, aby zawsze generować te same liczby, musisz zastanowić się, jak uczynić swój proces losowy powtarzalnym. Najłatwiejszym sposobem jest użycie funkcji <code><a href="https://rdrr.io/pkg/shiny/man/repeatable.html">repeatable()</a></code>.</li>
<li>Jeśli masz zakładki i chcesz “zakładkować” oraz przywracać aktywną zakładkę, upewnij się, że dostarczasz id w twoim wywołaniu funkcji <code><a href="https://rdrr.io/pkg/shiny/man/tabsetPanel.html">tabsetPanel()</a></code>.</li>
<li>Jeśli istnieją wejścia, które nie powinny być “zakładkowane”, np. zawierają prywatne informacje, które nie powinny być udostępniane, dołącz wywołanie funkcji <code><a href="https://rdrr.io/pkg/shiny/man/setBookmarkExclude.html">setBookmarkExclude()</a></code> gdzieś w funkcji serwera. Na przykład, <code>setBookmarkExclude(c("secret1", "secret2"))</code> zapewni, że wejścia <code>secret1</code> i <code>secret2</code> nie będą zakładkowane.</li>
<li>Jeśli ręcznie zarządzasz stanem reaktywnym w swoim własnym obiekcie <code><a href="https://rdrr.io/pkg/shiny/man/reactiveValues.html">reactiveValues()</a></code>, będziesz musiał użyć funkcji zwrotnych <code><a href="https://rdrr.io/pkg/shiny/man/onBookmark.html">onBookmark()</a></code> i <code><a href="https://rdrr.io/pkg/shiny/man/onBookmark.html">onRestore()</a></code>, aby ręcznie zapisać i załadować dodatkowy stan.</li>
</ul></section></section><section id="tidy-evaluation" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="tidy-evaluation">Tidy evaluation</h2>
<p><em>Tidy evaluation</em> jest kluczową koncepcją przy programowaniu z <code>tidyverse</code> w aplikacjach Shiny, która umożliwia płynniejszą eksplorację danych, ale stwarza pewne wyzwanie przy odnoszeniu się pośrednio do zmiennych, co utrudnia programowanie. W tym rozdziale przybliżymy, jak osadzać funkcje z <code>ggplot2</code> i <code>dplyr</code> w aplikacji Shiny<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="no-row-height column-margin column-container"><p><sup>1</sup>&nbsp;Techniki te są szerzej opisane w <a href="http://ggplot2.tidyverse.org/dev/articles/ggplot2-in-packages.html"><em>Using ggplot2 in packages</em></a>&nbsp;i&nbsp;<a href="http://dplyr.tidyverse.org/articles/programming.html"><em>Programming with dplyr</em></a>.</p></div><section id="motywacja" class="level3"><h3 class="anchored" data-anchor-id="motywacja">Motywacja</h3>
<p>Rozdział dotyczący <em>tidy evaluation</em> w kontekście tworzenia aplikacji Shiny z użyciem bibliotek tidyverse wprowadza do problematyki programowania z oceną zmiennych (<em>tidy evaluation</em>), która jest kluczowa przy interaktywnej eksploracji danych. Jednakże, ocena taka wprowadza trudności w pośrednim odwoływaniu się do zmiennych, co może utrudnić programowanie. Przykład zaprezentowany w sekcji “Motywacja” ma na celu ilustrowanie, jak można stworzyć aplikację Shiny, która umożliwia filtrowanie danych na podstawie wartości numerycznych przekraczających określony próg, wybranych przez użytkownika.</p>
<section id="przykład-aplikacji-shiny" class="level4"><h4 class="anchored" data-anchor-id="przykład-aplikacji-shiny">Przykład aplikacji Shiny</h4>
<p>Załóżmy, że chcemy stworzyć aplikację Shiny, która pozwala użytkownikowi filtrować dane dotyczące diamentów (używając wbudowanego zbioru danych <code>diamonds</code> z pakietu <code>ggplot2</code>) w celu wyświetlenia tych, które mają wartość większą niż określony próg dla wybranej zmiennej numerycznej, np. <code>carat</code>, <code>depth</code>, <code>price</code> itd.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Kod</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">num_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"carat"</span>, <span class="st">"depth"</span>, <span class="st">"table"</span>, <span class="st">"price"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"z"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># UI</span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/titlePanel.html">titlePanel</a></span><span class="op">(</span><span class="st">"Filtrowanie danych diamentów"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sidebarLayout.html">sidebarLayout</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sidebarLayout.html">sidebarPanel</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput</a></span><span class="op">(</span><span class="st">"var"</span>, <span class="st">"Zmienna"</span>, choices <span class="op">=</span> <span class="va">num_vars</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"min"</span>, <span class="st">"Minimalna wartość"</span>, value <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"goButton"</span>, <span class="st">"Filtruj"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sidebarLayout.html">mainPanel</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">tableOutput</a></span><span class="op">(</span><span class="st">"output"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># serwer</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">filteredData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">eventReactive</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">goButton</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html">req</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">var</span><span class="op">)</span> <span class="co"># Wymagane, aby zmienna była wybrana</span></span>
<span>    <span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">input</span><span class="op">$</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">input</span><span class="op">$</span><span class="va">min</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">renderTable</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">filteredData</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Wyświetla pierwsze 6 wierszy przefiltrowanych danych</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># wywołanie aplikacji</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>W tej aplikacji użytkownik ma możliwość wyboru zmiennej z zestawu <code>num_vars</code> i ustawienia minimalnej wartości dla tej zmiennej. Po wciśnięciu przycisku “Filtruj”, aplikacja filtruje dane i wyświetla pierwsze 6 wierszy spełniających kryteria filtracji.</p>
<div id="fig-filter1" class="quarto-figure quarto-figure-center quarto-float anchored" width="600" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-filter1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/Zrzut ekranu 2024-02-20 o 10.02.43.png" id="fig-filter1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" width="600">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-filter1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Rys.&nbsp;1
</figcaption></figure>
</div>
<p>Pierwotne podejście, w którym próbowano użyć <code>input$var &gt; input$min</code> bezpośrednio w funkcji <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>, nie działa poprawnie z powodu pośredniego odwoływania się do zmiennej (patrz <a href="#fig-filter1" class="quarto-xref">Rys.&nbsp;1</a>). W takim przypadku <code>dplyr</code> interpretuje <code>input$var</code> jako stałą wartość (nazwę zmiennej w postaci tekstowej), a nie jako kolumnę w ramce danych. Aby to naprawić, używamy <code>.data[[input$var]] &gt; input$min</code>, co pozwala na dynamiczne odwołanie się do kolumny ramki danych określonej przez zmienną wybraną przez użytkownika.</p>
</section></section><section id="maskowanie-danych" class="level3"><h3 class="anchored" data-anchor-id="maskowanie-danych">Maskowanie danych</h3>
<p>Funkcje maskujące dane pozwalają na używanie zmiennych z “bieżącej” ramki danych bez dodatkowej składni, są używane w wielu funkcjach dplyr oraz w aes() z ggplot2. Umożliwia to korzystanie ze zmiennych danych bez dodatkowej składni.</p>
<section id="rozpoczęcie-pracy" class="level4"><h4 class="anchored" data-anchor-id="rozpoczęcie-pracy">Rozpoczęcie pracy</h4>
<p>Przykład wykorzystuje <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> z zmienną danych (<code>carat</code>) oraz zmienną środowiskową (<code>min</code>). W tradycyjnym R musisz odwołać się do zmiennych danych za pomocą <code>$</code>, co oznacza, że często musisz powtarzać nazwę ramki danych, ale ułatwia to użycie pośrednictwa. W tidy evaluation można używać <code>.data</code> lub <code>.env</code>, aby być wyraźnym, czy mówimy o zmiennej danych czy zmiennej środowiskowej.</p>
</section></section><section id="przykład-ggplot2" class="level3"><h3 class="anchored" data-anchor-id="przykład-ggplot2">Przykład: ggplot2</h3>
<p>Pomysł ten można zastosować do dynamicznego wykresu, pozwalając użytkownikowi tworzyć wykres punktowy poprzez wybór zmiennych na osiach x i y.</p>
</section><section id="przykład-dplyr" class="level3"><h3 class="anchored" data-anchor-id="przykład-dplyr">Przykład: dplyr</h3>
<p>Ta sama technika działa również dla dplyr. Następująca aplikacja rozszerza poprzedni przykład, pozwalając wybrać zmienną do filtrowania, minimalną wartość do wyboru i zmienną do sortowania.</p>
</section><section id="dane-dostarczone-przez-użytkownika" class="level3"><h3 class="anchored" data-anchor-id="dane-dostarczone-przez-użytkownika">Dane dostarczone przez użytkownika</h3>
<p>Przed przejściem do tidy-selection, musimy omówić temat danych dostarczonych przez użytkownika. Aplikacja pozwala użytkownikowi przesłać plik tsv, a następnie wybrać zmienną i filtrować według niej. Istnieje subtelny problem z użyciem <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>, który może wystąpić, gdy ramka danych zawiera zmienną o nazwie <code>input</code>.</p>
</section><section id="dlaczego-nie-użyć-podstawowego-r" class="level3"><h3 class="anchored" data-anchor-id="dlaczego-nie-użyć-podstawowego-r">Dlaczego nie użyć podstawowego R?</h3>
<p>Można zastanawiać się, czy nie lepiej jest zrezygnować z <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>, i zamiast tego użyć odpowiednika w podstawowym R. To jest całkowicie uzasadnione stanowisko, o ile jesteś świadomy pracy, jaką <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> wykonuje za Ciebie, aby wygenerować równoważny kod w podstawowym R.</p>
</section><section id="tidy-selection" class="level3"><h3 class="anchored" data-anchor-id="tidy-selection">Tidy-selection</h3>
<p>Oprócz maskowania danych istnieje inna ważna część oceny tidy: tidy-selection. Tidy-selection zapewnia zwięzły sposób wyboru kolumn według pozycji, nazwy lub typu. Jest używany w <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select()</a></code> i <code><a href="https://dplyr.tidyverse.org/reference/across.html">dplyr::across()</a></code>, oraz w wielu funkcjach z tidyr.</p>
</section><section id="parse-eval" class="level3"><h3 class="anchored" data-anchor-id="parse-eval">parse() + eval()</h3>
<p>Warto wspomnieć o kombinacji <code>parse() + eval()</code>. Jest to kuszące podejście, ponieważ wymaga nauki bardzo</p>
<p>niewielu nowych koncepcji. Jednak ma to duże wady: łatwo jest przypadkowo stworzyć nieprawidłowy kod lub kod, który może być wykorzystany do czegoś, czego nie chciano.</p>
</section><section id="podsumowanie" class="level3"><h3 class="anchored" data-anchor-id="podsumowanie">Podsumowanie</h3>
<p>W tym rozdziale nauczyłeś się, jak tworzyć aplikacje Shiny, które pozwalają użytkownikowi wybrać, które zmienne zostaną przekazane do funkcji tidyverse, takich jak <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> i <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">ggplot2::aes()</a></code>. Wymaga to zrozumienia kluczowego rozróżnienia, o którym wcześniej nie trzeba było myśleć: różnicy między zmienną danych a zmienną środowiskową.</p>


</section></section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Skopiowano!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Skopiowano!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>